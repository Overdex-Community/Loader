repeat task.wait() until game:IsLoaded()

getgenv().CONFIG = getgenv().CONFIG or {
    AutobuyallRod = true,
    AutoFish      = true,
    BuyAllBait    = true,
    Optimize      = true,
}

local RS          = game:GetService("ReplicatedStorage")
local Players     = game:GetService("Players")
local RunService  = game:GetService("RunService")
local Workspace   = game:GetService("Workspace")
local Lighting    = game:GetService("Lighting")
local CoreGui     = game:GetService("CoreGui")
local VirtualUser = game:GetService("VirtualUser")
local LP          = Players.LocalPlayer

local Net           = require(RS.Packages.Net)
local ReplionClient = require(RS.Packages.Replion).Client
local ItemUtil      = require(RS.Shared.ItemUtility)
local ItemStr       = require(RS.Modules.ItemStringUtility)
local TierUtil      = require(RS.Shared.TierUtility)
local FC            = require(RS.Controllers.FishingController)
local CONST         = require(RS.Shared.Constants)

local RF_PurchaseRod     = Net:RemoteFunction("PurchaseFishingRod")
local RE_EquipItem       = Net:RemoteEvent("EquipItem")
local RE_EquipFromHotbar = Net:RemoteEvent("EquipToolFromHotbar")
local FavoriteItem       = Net:RemoteEvent("FavoriteItem")
local SellItem           = Net:RemoteFunction("SellItem")
local RF_PurchaseBait    = Net:RemoteFunction("PurchaseBait")
local RE_EquipBait       = Net:RemoteEvent("EquipBait")

local Data = ReplionClient:WaitReplion("Data")

local function _ancHum(inst)
    local o=inst
    while o do
        if o:IsA("Model") and o:FindFirstChildOfClass("Humanoid") then return true end
        o=o.Parent
    end
    return false
end

local function _prot(inst)
    if inst==Workspace.CurrentCamera or inst==Workspace.Terrain then return true end
    if _ancHum(inst) then return true end
    return false
end

local function _disableIfExists(x, prop)
    pcall(function()
        if x[prop] ~= nil then x[prop] = false end
    end)
end

local function _transparentDecal(d)
    pcall(function()
        if d:IsA("Decal") or d:IsA("Texture") then d.Transparency = 1 end
    end)
end

local function _disableParticles(o)
    pcall(function()
        if o:IsA("ParticleEmitter") then o.Enabled = false end
        if o:IsA("Trail")           then o.Enabled = false end
        if o:IsA("Beam")            then o.Enabled = false end
        if o:IsA("Fire")            then o.Enabled = false end
        if o:IsA("Smoke")           then o.Enabled = false end
        if o:IsA("Sparkles")        then o.Enabled = false end
        if o:IsA("Highlight")       then o.Enabled = false end
    end)
end

local function _disableLights(o)
    pcall(function()
        if o:IsA("PointLight") or o:IsA("SpotLight") or o:IsA("SurfaceLight") then
            o.Enabled = false
        end
    end)
end

local function _flattenPart(o, black)
    pcall(function()
        if o:IsA("BasePart") then
            o.Material = Enum.Material.SmoothPlastic
            o.CastShadow = false
            o.Reflectance = 0
            if black then o.Color = Color3.new(0,0,0) end
        end
    end)
end

local function _hidePart(o, black)
    pcall(function()
        if o:IsA("BasePart") then
            o.LocalTransparencyModifier = 1
            o.Transparency = 1
            o.CanCollide = false
            o.CanTouch = false
            if black then o.Color = Color3.new(0,0,0) end
        end
    end)
end

local function APPLY_OPTIMIZE()
    if not getgenv().CONFIG.Optimize or getgenv().__OPT_APPLIED then return end
    getgenv().__OPT_APPLIED = true

    local HIDE_GUI, BLACK_WORLD, STRIP_VISUALS, SIMPLE_MATS = true, true, true, true
    local INVISIBLE_MAP = true
    local DISABLE_3D, ANTI_AFK = true, true

    if HIDE_GUI then
        pcall(function()
            local pg=LP:WaitForChild("PlayerGui",5)
            if pg then
                for _,g in ipairs(pg:GetChildren()) do
                    if g:IsA("ScreenGui") then
                        local keep = g:GetAttribute("IsOurHUD") == true
                        g.Enabled = keep
                    end
                end
                pg.ChildAdded:Connect(function(ch)
                    pcall(function()
                        if ch:IsA("ScreenGui") and ch:GetAttribute("IsOurHUD") ~= true then
                            ch.Enabled = false
                        end
                    end)
                end)
            end
        end)
    end

    if BLACK_WORLD then
        for _,o in ipairs(Lighting:GetChildren()) do
            _disableIfExists(o, "Enabled")
        end
        Lighting.Brightness=0
        Lighting.GlobalShadows=false
        Lighting.Ambient=Color3.new(0,0,0)
        Lighting.OutdoorAmbient=Color3.new(0,0,0)
        Lighting.FogColor=Color3.new(0,0,0)
        Lighting.FogStart,Lighting.FogEnd=0,1
        pcall(function() Lighting.Technology=Enum.Technology.Compatibility end)
        if not Lighting:FindFirstChild("cc_black") then
            local cc=Instance.new("ColorCorrectionEffect")
            cc.Name="cc_black"; cc.Brightness=-1; cc.Contrast=-1; cc.Saturation=-1; cc.TintColor=Color3.new(0,0,0)
            cc.Parent=Lighting
        end
    end

    for _,o in ipairs(Workspace:GetDescendants()) do
        if _prot(o) then continue end
        if STRIP_VISUALS then
            _transparentDecal(o)
            _disableParticles(o)
            _disableLights(o)
        end
        if SIMPLE_MATS then
            _flattenPart(o, BLACK_WORLD)
        end
        if INVISIBLE_MAP then
            _hidePart(o, BLACK_WORLD)
        end
    end

    pcall(function()
        local t=Workspace.Terrain
        t.WaterTransparency=1
        t.WaterReflectance=1
        t.WaterWaveSize=0
        t.WaterWaveSpeed=0
        t.WaterColor=Color3.new(0,0,0)
    end)

    if DISABLE_3D then
        pcall(function() RunService:Set3dRenderingEnabled(false) end)
    end

    if ANTI_AFK and not getgenv().__OPT_ANTIAFK then
        getgenv().__OPT_ANTIAFK=true
        LP.Idled:Connect(function()
            pcall(function() VirtualUser:CaptureController(); VirtualUser:ClickButton2(Vector2.new()) end)
        end)
    end

    task.spawn(function()
        while task.wait(5) and getgenv().CONFIG.Optimize do
            if DISABLE_3D then pcall(function() RunService:Set3dRenderingEnabled(false) end) end
            if BLACK_WORLD then
                pcall(function()
                    Lighting.Brightness=0
                    Lighting.GlobalShadows=false
                    Lighting.Ambient=Color3.new(0,0,0)
                    Lighting.OutdoorAmbient=Color3.new(0,0,0)
                    Lighting.FogColor=Color3.new(0,0,0)
                    Lighting.FogStart,Lighting.FogEnd=0,1
                end)
            end
        end
    end)
end

APPLY_OPTIMIZE()

local function coins()
    local ok,v=pcall(function() return Data:GetExpect("Coins") end)
    return ok and (v or 0) or 0
end

local function hasRodId(id)
    local inv = Data:GetExpect({ "Inventory", "Fishing Rods" }) or {}
    for _, it in ipairs(inv) do if it.Id == id then return true end end
    return false
end

local function infoOf(id) local ok,inf=pcall(function() return ItemUtil:GetItemData(id) end); return ok and inf or nil end
local function luckPct(inf) local r=inf and inf.RollData; return (r and typeof(r.BaseLuck)=="number") and math.floor(r.BaseLuck*100) or 0 end

local function invRods()
    local t = Data:Get({ "Inventory", "Fishing Rods" }) or {}
    local out = {}
    for _, e in ipairs(t) do
        local inf = infoOf(e.Id)
        if inf and inf.Data and inf.Data.Type == "Fishing Rods" then
            out[#out+1] = { UUID=e.UUID, Id=e.Id, Name=inf.Data.Name or tostring(e.Id), Luck=luckPct(inf) }
        end
    end
    return out
end

local function bestRod()
    local best
    for _, r in ipairs(invRods()) do if not best or r.Luck > best.Luck then best = r end end
    return best
end

local function equippedRodUUID()
    local eq = Data:Get("EquippedItems"); if typeof(eq)~="table" then return nil end
    local inv = Data:Get({ "Inventory", "Fishing Rods" }) or {}
    local set = {}; for _, e in ipairs(inv) do set[e.UUID]=true end
    for _, u in ipairs(eq) do if set[u] then return u end end
    return nil
end

local function ensureHeldSlot1() pcall(function() RE_EquipFromHotbar:FireServer(1) end) end
local function ensureEquippedAndHeld()
    local b = bestRod(); if not b then return end
    if equippedRodUUID() ~= b.UUID then
        pcall(function() RE_EquipItem:FireServer(b.UUID, "Fishing Rods") end)
        task.wait(0.15)
    end
    ensureHeldSlot1(); task.delay(0.2, ensureHeldSlot1)
end

local function scanShopAndBuyRods()
    if not getgenv().CONFIG.AutobuyallRod then return end
    local shop = ItemUtil:GetFishingRods() or {}
    for _, rod in ipairs(shop) do
        if not rod.HiddenInShop and not rod.LinkedGamePass then
            local id   = rod.Data and rod.Data.Id
            local price= tonumber(rod.Price or 0) or 0
            if id and price>0 and not hasRodId(id) and coins()>=price then
                pcall(function() RF_PurchaseRod:InvokeServer(id) end)
                task.wait(0.35)
            end
        end
    end
end

if type(FC)=="table" then FC._getPower=function() return 1 end end

LP.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
    task.wait(1)
    VirtualUser:Button2Up(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
end)

local DEFAULT_POS = Vector3.new(-102.049, -1.172, 2669.954)
local PAD_NAME    = "FishPad_Local"
local CLICK_BURST = 50

local function propsInstance() return workspace:FindFirstChild("Props") end

local function getPropsPosition()
    local props = propsInstance()
    if not props then return nil end
    if props:IsA("BasePart") then return props.Position end
    if props:IsA("Model") then return props:GetPivot().Position end
    local firstPart
    for _, inst in ipairs(props:GetDescendants()) do
        if inst:IsA("BasePart") then firstPart=inst; break end
    end
    return firstPart and firstPart.Position or nil
end

local function currentTargetPos()
    return getPropsPosition() or DEFAULT_POS
end

local function pad()
    local p = workspace:FindFirstChild(PAD_NAME)
    if not p then
        p = Instance.new("Part")
        p.Name = PAD_NAME
        p.Anchored = true
        p.CanCollide = true
        p.CanQuery = false
        p.Size = Vector3.new(16,1,16)
        p.Transparency = 1
        p.Parent = workspace
    end
    return p
end

local function surfaceY(v3)
    local origin=v3+Vector3.new(0,500,0)
    local params=RaycastParams.new()
    params.FilterDescendantsInstances={ LP.Character, pad() }
    params.FilterType=Enum.RaycastFilterType.Exclude
    local hit=workspace:Raycast(origin, Vector3.new(0,-2000,0), params)
    return hit and hit.Position.Y or v3.Y
end

local function tpToTarget()
    if not (LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")) then return end
    local tgt = currentTargetPos()
    local p = pad()
    local y = surfaceY(tgt) + 3
    p.CFrame = CFrame.new(Vector3.new(tgt.X, y, tgt.Z))
    LP.Character.HumanoidRootPart.CFrame = p.CFrame + Vector3.new(0,3,0)
end

LP.CharacterAdded:Connect(function()
    repeat task.wait() until LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
    task.delay(0.2, tpToTarget)
end)
tpToTarget()

local function ReelBurst()
    while getgenv().CONFIG.AutoFish and FC:GetCurrentGUID() do
        for _=1,CLICK_BURST do FC:RequestFishingMinigameClick() end
        RunService.Heartbeat:Wait()
    end
end

local function getFishDataFromItems(id)
    local info = ItemUtil.GetItemDataFromItemType("Items", id)
    if info and info.Data and info.Data.Type=="Fishes" then return info end
    return nil
end

local function fishName(it)
    local info=getFishDataFromItems(it.Id)
    if ItemStr and ItemStr.GetItemName then
        local ok,res=pcall(function() return ItemStr.GetItemName(it, info) end)
        if ok and res then return res end
    end
    if info and info.Data and info.Data.Name then return tostring(info.Data.Name) end
    return tostring(it.Id)
end

local function tierNumToName(n)
    if typeof(n)=="number" and TierUtil and TierUtil.GetTier then
        local t=TierUtil:GetTier(n); if t and t.Name then return tostring(t.Name) end
    end
    return nil
end

local function fishRarity(it)
    local info=getFishDataFromItems(it.Id)
    local m=it.Metadata or {}
    if typeof(m.RarityName)=="string" and #m.RarityName>0 then return m.RarityName end
    for _,v in ipairs({m.Rarity,m.RarityId,m.Tier,m.RarityIndex,m.RarityLevel}) do
        local name=tierNumToName(v); if name then return name end
        if typeof(v)=="string" and #v>0 then return v end
    end
    if info then
        if info.Probability and info.Probability.Chance and TierUtil and TierUtil.GetTierFromRarity then
            local t=TierUtil:GetTierFromRarity(info.Probability.Chance); if t and t.Name then return tostring(t.Name) end
        end
        if info.Data and info.Data.Tier~=nil then
            local name=tierNumToName(info.Data.Tier); if name then return name end
        end
    end
    if ItemStr and ItemStr.GetRarityName then
        local ok,r=pcall(function() return ItemStr.GetRarityName(it, info) end); if ok and r then return tostring(r) end
    end
    return "Unknown"
end

local function fishKg(it)
    local m=it.Metadata or {}
    local w=m.Weight or m.weight or it.Weight or m.Kg or m.kg
    if typeof(w)=="number" then return string.format("%.2fkg", w) end
    return tostring(w or "?kg")
end

local function rawItems() return Data:Get({ "Inventory", "Items" }) or {} end

local function iterFishEntries(cb)
    for k,v in pairs(rawItems()) do
        local it,uuid=v,nil
        if typeof(v)=="table" and v.Id==nil and v.Item then
            uuid=v.UUID
            it={ Id=v.Item.Id or v.Item.ItemId, Metadata=v.Metadata or v.Item.Metadata, Quantity=v.Quantity or 1, UUID=uuid }
        end
        if typeof(it)=="table" and it.Id~=nil then
            local info=getFishDataFromItems(it.Id); if info then cb(it, info, uuid or it.UUID) end
        elseif typeof(v)=="number" then
            local id=tonumber(k) or k; local info=getFishDataFromItems(id)
            if info then cb({Id=id, Quantity=v}, info, nil) end
        end
    end
end

local function usedSlots() if CONST and CONST.CountInventorySize then return CONST:CountInventorySize(Data) end; return (Data:Get("InventorySize") or 0) end
local function maxSlots() local cap=Data:Get("MaxInventorySize"); if typeof(cap)~="number" then cap=CONST.MaxInventorySize end; return cap or 0 end

local favorited, soldOnce = {}, {}
local function isSecret(r) return r and string.find(string.upper(tostring(r)), "SECRET")~=nil end
local function sellOne(uuid) if not uuid or soldOnce[uuid] then return end; soldOnce[uuid]=true; pcall(function() SellItem:InvokeServer(uuid) end) end

local function processEntireInventory()
    local cap=maxSlots(); local used=usedSlots()
    iterFishEntries(function(it)
        local uid=it.UUID; local name=fishName(it); local rar=fishRarity(it); local kg=fishKg(it)
        print(("%d/%d | %s | %s | %s [%s]"):format(used, cap, name, rar, kg, tostring(uid or ("ID:"..tostring(it.Id)))))
        if uid then
            if isSecret(rar) then
                if not favorited[uid] then favorited[uid]=true; task.defer(function() pcall(function() FavoriteItem:FireServer(uid) end) end) end
            else
                task.defer(function() task.wait(0.1); sellOne(uid) end)
            end
        end
    end)
end

local ONLY_COINS, LOOP_INTERVAL, BUY_COOLDOWN, EQUIP_COOLDOWN = true, 1.0, 0.3, 0.2
local function invBaits() return Data:GetExpect({ "Inventory", "Baits" }) or {} end
local function ownedBaitMap() local m={}; for _,it in ipairs(invBaits()) do if it.Id then m[it.Id]=true end end; return m end

local function baitLuckyScore(bait)
    local mods=bait and bait.Modifiers; if not mods then return 0 end
    local best=0; for k,v in pairs(mods) do if typeof(v)=="number" and string.find(string.lower(tostring(k)), "luck") then if v>best then best=v end end end
    return best
end

local function currentEquippedBaitIs(bestId)
    local eqType=Data:GetExpect("EquippedType"); local eqId=Data:GetExpect("EquippedId")
    return (eqType=="Baits" or eqType=="Bait" or eqType=="Bait Items") and eqId==bestId
end

local purchasing_bait, equipping_bait = false, false

local function buyMissingBaits()
    if not getgenv().CONFIG.BuyAllBait or purchasing_bait then return end
    purchasing_bait=true
    local owned=ownedBaitMap(); local baits=ItemUtil:GetBaits() or {}
    table.sort(baits, function(a,b) local pa=a.Price or math.huge; local pb=b.Price or math.huge; return pa<pb end)
    for _, bait in ipairs(baits) do
        local id=bait.Data and bait.Data.Id; local price=bait.Price; local isGP=bait.LinkedGamePass~=nil
        if id and not owned[id] then
            if ONLY_COINS and isGP then
            else
                if typeof(price)=="number" and coins()>=price then
                    local ok,res=pcall(function() return RF_PurchaseBait:InvokeServer(id) end)
                    if ok and res then owned[id]=true; task.wait(BUY_COOLDOWN) end
                end
            end
        end
    end
    purchasing_bait=false
end

local function equipBestLuckyOwnedBait()
    if equipping_bait then return end
    equipping_bait=true
    local owned=ownedBaitMap(); local baits=ItemUtil:GetBaits() or {}
    local bestId,bestScore=nil,-math.huge
    for _, bait in ipairs(baits) do
        local id=bait.Data and bait.Data.Id
        if id and owned[id] then
            local score=baitLuckyScore(bait)
            if score>bestScore then bestScore=score; bestId=id end
        end
    end
    if bestId and not currentEquippedBaitIs(bestId) then
        pcall(function() RE_EquipBait:FireServer(bestId) end)
        task.wait(EQUIP_COOLDOWN)
    end
    equipping_bait=false
end

pcall(function()
    Data:OnChange({ "Inventory", "Fishing Rods" }, ensureEquippedAndHeld)
    Data:OnChange("EquippedItems", ensureEquippedAndHeld)
    Data:OnChange("Coins", function() scanShopAndBuyRods(); if getgenv().CONFIG.BuyAllBait then task.defer(buyMissingBaits) end end)
    Data:OnChange({ "Inventory", "Items" }, processEntireInventory)
    if Data.OnArrayInsert then
        Data:OnArrayInsert({ "Inventory", "Baits" }, function() task.defer(equipBestLuckyOwnedBait) end)
        Data:OnArrayRemove({ "Inventory", "Baits" }, function() task.defer(equipBestLuckyOwnedBait) end)
    else
        Data:OnChange({ "Inventory", "Baits" }, function() task.defer(equipBestLuckyOwnedBait) end)
    end
end)

LP.CharacterAdded:Connect(function() task.wait(0.5); ensureEquippedAndHeld() end)

task.spawn(function()
    while true do
        scanShopAndBuyRods()
        ensureEquippedAndHeld()
        task.wait(1.0)
    end
end)

task.spawn(function()
    while true do
        task.wait(0.5)
        processEntireInventory()
    end
end)

task.spawn(function()
    while true do
        if getgenv().CONFIG.BuyAllBait then buyMissingBaits() end
        equipBestLuckyOwnedBait()
        task.wait(LOOP_INTERVAL)
    end
end)

task.spawn(function()
    local lastHasProps = nil
    while true do
        local hasProps = workspace:FindFirstChild("Props") ~= nil
        if lastHasProps == nil or hasProps ~= lastHasProps then
            tpToTarget()
            lastHasProps = hasProps
        end
        task.wait(0.25)
    end
end)

task.spawn(function()
    while true do
        task.wait(0.05)
        if not getgenv().CONFIG.AutoFish then continue end
        local c=LP.Character; local hrp=c and c:FindFirstChild("HumanoidRootPart")
        local p=workspace:FindFirstChild(PAD_NAME)
        if hrp and p and (hrp.Position-(p.Position+Vector3.new(0,3,0))).Magnitude>8 then
            tpToTarget()
        end
        if Data:GetExpect("EquippedType")=="Fishing Rods" then
            if FC:GetCurrentGUID() then
                ReelBurst()
            elseif not FC:OnCooldown() then
                FC:RequestChargeFishingRod(currentTargetPos(), true)
            end
        end
    end
end)

do
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local UserInputService = game:GetService("UserInputService")
    local Cam = workspace.CurrentCamera
    local LP = Players.LocalPlayer

    local RS = rawget(getfenv(), "RS") or game:GetService("ReplicatedStorage")
    local ReplionClient = rawget(getfenv(), "ReplionClient") or require(RS.Packages.Replion).Client
    local ItemUtil = rawget(getfenv(), "ItemUtil") or require(RS.Shared.ItemUtility)
    local ItemStr  = rawget(getfenv(), "ItemStr")  or require(RS.Modules.ItemStringUtility)
    local TierUtil = rawget(getfenv(), "TierUtil") or require(RS.Shared.TierUtility)
    local Data     = rawget(getfenv(), "Data")     or ReplionClient:WaitReplion("Data")

    local HUD_DIRTY = true
    local function HUD_MarkDirty() HUD_DIRTY = true end

    local function HUD_Protect(g)
        pcall(function()
            if syn and syn.protect_gui then syn.protect_gui(g) end
            if protectgui then protectgui(g) end
        end)
    end
    local function HUD_Short(n)
        if typeof(n) ~= "number" then return tostring(n) end
        local a = math.abs(n)
        local function fmt(x, suf)
            local s = tostring(x):gsub("%.0+$","")
            return (n<0 and "-" or "")..s..suf
        end
        if a>=1e12 then return fmt(math.floor(n/1e10)/100,"T")
        elseif a>=1e9 then return fmt(math.floor(n/1e7)/100,"B")
        elseif a>=1e6 then return fmt(math.floor(n/1e4)/100,"M")
        elseif a>=1e3 then
            local k=n/1e3
            if math.abs(k-math.floor(k))<1e-9 then return fmt(math.floor(k+0.5),"k")
            else return fmt(math.floor(k*100+0.5)/100,"k") end
        else return tostring(n) end
    end
    local function HUD_StarsFrom(any)
        if typeof(any)~="table" then return 0 end
        local c={any.Stars,any.Star,any.StarCount,any.Level,any.UpgradeLevel,any.EnchantLevel,any.RarityStars,any.StarTier,any.Star_Level}
        for _,v in ipairs(c) do
            if typeof(v)=="number" then return math.floor(v) end
            if typeof(v)=="string" and tonumber(v) then return math.floor(tonumber(v)) end
        end
        local m=any.Metadata or any.meta or any.Props
        if typeof(m)=="table" then
            local s=HUD_StarsFrom(m) if s>0 then return s end
            if typeof(m.Upgrades)=="table" then
                local s2=HUD_StarsFrom(m.Upgrades) if s2>0 then return s2 end
            end
        end
        return 0
    end
    local function HUD_TierNumToName(n)
        if typeof(n)=="number" and TierUtil and TierUtil.GetTier then
            local t=TierUtil:GetTier(n); return t and t.Name or nil
        end
    end

    local HUD_BAITS_BY_ID = {}
    pcall(function()
        for _, b in ipairs(ItemUtil:GetBaits() or {}) do
            local id = b.Data and b.Data.Id
            if id ~= nil then HUD_BAITS_BY_ID[id] = b end
        end
    end)

    local function HUD_BaitName(id)
        local b = HUD_BAITS_BY_ID[id]
        if not b then return tostring(id) end
        if ItemStr and ItemStr.GetItemName then
            local ok, name = pcall(function() return ItemStr.GetItemName({Id=id}, b) end)
            if ok and name then return name end
        end
        return (b.Data and b.Data.Name) or tostring(id)
    end

    local HUD_POSSIBLE_KEYS = {
        "EquippedBaitId","SelectedBaitId","CurrentBaitId","BaitId",
        {"Equipped","BaitId"},{"Equipped","Bait"},{"Equipment","Bait"},{"Equipment","BaitId"},
        {"Fishing","BaitId"},{"Fishing","Bait"},{"EquippedData","BaitId"},
    }

    local function HUD_ReadPath(path) return Data:Get(path) end
    local function HUD_CoerceId(v)
        if v == nil then return nil end
        if typeof(v)=="table" then
            if v.Id ~= nil then return v.Id end
            if v.ItemId ~= nil then return v.ItemId end
            if v.Data and v.Data.Id ~= nil then return v.Data.Id end
            return nil
        end
        return v
    end

    local function HUD_FindEquippedBaitEntryInInventory()
        local arr = Data:Get({"Inventory","Baits"}) or {}
        for _, it in ipairs(arr) do
            if (it.Equipped == true) or (it.IsEquipped == true) or (it.Metadata and it.Metadata.Equipped == true) then
                return it
            end
        end
        return nil
    end

    local function HUD_EquippedBaitText()
        local invBaits = Data:Get({"Inventory","Baits"}) or {}
        for _, key in ipairs(HUD_POSSIBLE_KEYS) do
            local v = HUD_ReadPath(key)
            local id = HUD_CoerceId(v)
            if id ~= nil then
                local bestEntry, bestStar = nil, -1
                for _, it in ipairs(invBaits) do
                    if it.Id == id then
                        local st = HUD_StarsFrom(it)
                        if (it.Equipped or (it.Metadata and it.Metadata.Equipped)) then
                            bestEntry, bestStar = it, st; break
                        end
                        if st > bestStar then bestEntry, bestStar = it, st end
                    end
                end
                local name = HUD_BaitName(id)
                local star = bestEntry and HUD_StarsFrom(bestEntry) or 0
                if star>0 then name = name.." ★"..star end
                return name
            end
        end
        local flagged = HUD_FindEquippedBaitEntryInInventory()
        if flagged then
            local name = HUD_BaitName(flagged.Id)
            local star = HUD_StarsFrom(flagged)
            if star>0 then name = name.." ★"..star end
            return name
        end
        local et = Data:Get("EquippedType")
        local id = Data:Get("EquippedId")
        if et=="Baits" or et=="Bait" or et=="Bait Items" then
            local name = HUD_BaitName(id)
            local star = 0
            for _, it in ipairs(invBaits) do if it.Id==id then star = math.max(star, HUD_StarsFrom(it)) end end
            if star>0 then name = name.." ★"..star end
            return name
        end
        return "NONE"
    end

    local function HUD_RodText()
        local inv = Data:Get({"Inventory","Fishing Rods"}) or {}
        local eqSet = {}
        local eq = Data:Get("EquippedItems")
        if typeof(eq)=="table" then for _,u in ipairs(eq) do eqSet[u]=true end end
        local best
        for _,e in ipairs(inv) do
            local inf = ItemUtil:GetItemData(e.Id)
            local luck = (inf and inf.RollData and typeof(inf.RollData.BaseLuck)=="number") and math.floor(inf.RollData.BaseLuck*100) or 0
            if eqSet[e.UUID] then
                local name = (inf and inf.Data and inf.Data.Name) or tostring(e.Id)
                local star = HUD_StarsFrom(e)
                return name .. (star>0 and (" ★"..star) or "") .. (luck>0 and (" (+"..luck.."%)") or "")
            end
            if not best or luck>(best.luck or -1) then best={name=(inf and inf.Data and inf.Data.Name) or tostring(e.Id), luck=luck, star=HUD_StarsFrom(e)} end
        end
        if best then
            return best.name .. (best.star>0 and (" ★"..best.star) or "") .. (best.luck>0 and (" (+"..best.luck.."%)") or "")
        end
        return "NONE"
    end

    local function HUD_Coins()
        local ok,v=pcall(function() return Data:GetExpect("Coins") end)
        return ok and (v or 0) or 0
    end

    local function HUD_Leaderstats() return LP:FindFirstChild("leaderstats") end
    local HUD_CAUGHT_NAMES = {"Caught","cought","FishCaught","FishesCaught"}
    local HUD_RAREST_NAMES = {"Rarest","rarest","RarestFish","BestRarity","Best Fish","Best","TopRarity"}

    local function HUD_FindStatByNames(names)
        local ls = HUD_Leaderstats() if not ls then return nil end
        for _,obj in ipairs(ls:GetChildren()) do
            local nm = string.lower(obj.Name)
            for _,want in ipairs(names) do if nm==string.lower(want) then return obj end end
            if string.find(nm, "rare") then return obj end
        end
        return nil
    end
    local function HUD_CaughtText()
        local s = HUD_FindStatByNames(HUD_CAUGHT_NAMES) if not s then return "—" end
        local v = tonumber(s.Value) if v then return HUD_Short(v) end
        return tostring(s.Value)
    end
    local function HUD_RarestText()
        local s = HUD_FindStatByNames(HUD_RAREST_NAMES) if not s then return "—" end
        return tostring(s.Value)
    end

    local HUD_SG = Instance.new("ScreenGui")
    HUD_SG.Name = "FishHUD_LED_Rainbow"
    HUD_SG.IgnoreGuiInset = true
    HUD_SG.ResetOnSpawn = false
    HUD_SG.DisplayOrder = 2^31-1
    HUD_SG:SetAttribute("IsOurHUD", true)
    HUD_Protect(HUD_SG)
    local function _safe_gui_parent()
        local ok, ui = pcall(function() return (gethui and gethui()) end)
        return (ok and ui) or CoreGui
    end
    HUD_SG.Parent = _safe_gui_parent()
    HUD_SG.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local Overlay=Instance.new("Frame")
    Overlay.Size=UDim2.fromScale(1,1)
    Overlay.BackgroundColor3=Color3.fromRGB(0,0,0)
    Overlay.BackgroundTransparency=0
    Overlay.BorderSizePixel=0
    Overlay.Active=false
    Overlay.Parent=HUD_SG

    local Card=Instance.new("Frame")
    Card.Size=UDim2.new(0,700,0,300)
    Card.AnchorPoint=Vector2.new(0.5,0.5)
    Card.Position=UDim2.fromScale(0.5,0.5)
    Card.BackgroundColor3=Color3.fromRGB(10,10,12)
    Card.BackgroundTransparency=0.05
    Card.BorderSizePixel=0
    Card.Active=false
    Card.Parent=Overlay
    local CC=Instance.new("UICorner",Card) CC.CornerRadius=UDim.new(0,20)

    local Neon=Instance.new("Frame")
    Neon.Size=UDim2.fromScale(1,1)
    Neon.BackgroundTransparency=1
    Neon.Parent=Card
    local NeonStroke=Instance.new("UIStroke",Neon)
    NeonStroke.Thickness=3
    NeonStroke.LineJoinMode=Enum.LineJoinMode.Round
    local NeonGrad=Instance.new("UIGradient",NeonStroke)
    NeonGrad.Color=ColorSequence.new{
        ColorSequenceKeypoint.new(0,Color3.fromRGB(60,160,255)),
        ColorSequenceKeypoint.new(0.5,Color3.fromRGB(100,220,255)),
        ColorSequenceKeypoint.new(1,Color3.fromRGB(60,160,255)),
    }
    task.spawn(function() while task.wait(0.02) do NeonGrad.Rotation=(NeonGrad.Rotation+1)%360 end end)

    local Title=Instance.new("TextLabel")
    Title.BackgroundTransparency=1
    Title.Size=UDim2.new(1,-40,0,50)
    Title.Position=UDim2.new(0,20,0,20)
    Title.Font=Enum.Font.GothamBlack
    Title.TextScaled=true
    Title.TextXAlignment=Enum.TextXAlignment.Left
    Title.TextYAlignment=Enum.TextYAlignment.Center
    Title.TextColor3=Color3.fromRGB(235,240,255)
    local TitleTS=Instance.new("UITextSizeConstraint",Title)
    TitleTS.MinTextSize=12
    TitleTS.MaxTextSize=42
    Title.Parent=Card

    local function HUD_MkRow(parent,y,h,tsMax)
        local holder=Instance.new("Frame")
        holder.BackgroundTransparency=1
        holder.Position=UDim2.new(0,20,0,y)
        holder.Size=UDim2.new(1,-40,0,h)
        holder.Parent=parent

        local back=Instance.new("Frame")
        back.Size=UDim2.fromScale(1,1)
        back.BackgroundColor3=Color3.fromRGB(12,12,16)
        back.BackgroundTransparency=0.25
        back.Parent=holder
        local bc=Instance.new("UICorner",back) bc.CornerRadius=UDim.new(0,12)

        local label=Instance.new("TextLabel")
        label.BackgroundTransparency=1
        label.Size=UDim2.new(1,-24,1,-12)
        label.Position=UDim2.new(0,12,0,6)
        label.Font=Enum.Font.GothamMedium
        label.TextScaled=true
        label.TextXAlignment=Enum.TextXAlignment.Left
        label.TextYAlignment=Enum.TextYAlignment.Center
        label.TextColor3=Color3.fromRGB(235,240,255)
        local tsc=Instance.new("UITextSizeConstraint",label)
        tsc.MinTextSize=12
        tsc.MaxTextSize=tsMax
        label.Parent=holder

        local ledWrap=Instance.new("Frame")
        ledWrap.BackgroundTransparency=1
        ledWrap.Size=UDim2.fromScale(1,1)
        ledWrap.Parent=back
        local ledCorner=Instance.new("UICorner",ledWrap) ledCorner.CornerRadius=UDim.new(0,12)
        local ledStroke=Instance.new("UIStroke",ledWrap)
        ledStroke.Thickness=3
        ledStroke.Transparency=0.1
        ledStroke.ApplyStrokeMode=Enum.ApplyStrokeMode.Border
        local function rainbowSeq()
            local ks,steps={},12
            for i=0,steps do local t=i/steps; ks[#ks+1]=ColorSequenceKeypoint.new(t,Color3.fromHSV(t,1,1)) end
            return ColorSequence.new(ks)
        end
        local G1=Instance.new("UIGradient",ledStroke); G1.Color=rainbowSeq()
        task.spawn(function() local r=0; while task.wait(0.015) do r=(r+1.5)%360; G1.Rotation=r end end)

        local glow=Instance.new("ImageLabel")
        glow.BackgroundTransparency=1
        glow.Image="rbxassetid://1316045217"
        glow.ScaleType=Enum.ScaleType.Slice
        glow.SliceCenter=Rect.new(10,10,118,118)
        glow.Size=UDim2.new(1,12,1,12)
        glow.Position=UDim2.new(0,-6,0,-6)
        glow.ImageTransparency=0.86
        glow.ImageColor3=Color3.fromRGB(180,220,255)
        glow.Parent=back

        return label
    end

    local CoinsLb = HUD_MkRow(Card,80,40,30)
    local RodLb   = HUD_MkRow(Card,126,36,28)
    local BaitLb  = HUD_MkRow(Card,166,36,28)
    local CaughtLb= HUD_MkRow(Card,206,36,28)
    local RarestLb= HUD_MkRow(Card,246,36,28)

    local function HUD_ApplyScale()
        local vh=Cam.ViewportSize.Y
        local k=math.clamp(vh/720,0.75,1.8)
        Card.Size=UDim2.new(0,math.floor(700*k),0,math.floor(300*k))
        TitleTS.MaxTextSize=math.max(24, math.floor(42*k))
    end
    HUD_ApplyScale()
    Cam:GetPropertyChangedSignal("ViewportSize"):Connect(HUD_ApplyScale)
    UserInputService.WindowFocusReleased:Connect(HUD_ApplyScale)
    UserInputService.WindowFocused:Connect(HUD_ApplyScale)

    local _coinsShown = 0
    local function HUD_TweenCoins(toValue)
        toValue = tonumber(toValue) or 0
        local from = _coinsShown
        local dur = math.clamp(math.abs(toValue-from)/math.max(1,toValue)*0.6,0.15,0.6)
        local t0 = tick()
        local conn
        conn = RunService.Heartbeat:Connect(function()
            local a=math.clamp((tick()-t0)/dur,0,1)
            local eased=1-(1-a)*(1-a)
            _coinsShown = from + (toValue-from)*eased
            CoinsLb.Text = "COINS: "..HUD_Short(_coinsShown)
            if a>=1 then conn:Disconnect() end
        end)
    end

    local function HUD_DisplayName()
        return (LP.DisplayName and LP.DisplayName~="" and LP.DisplayName) or LP.Name or "Player"
    end
    local function HUD_HasSecret()
        local items=Data:Get({"Inventory","Items"}) or {}
        for k,v in pairs(items) do
            local it=v
            if typeof(v)=="table" and v.Id==nil and v.Item then
                it={Id=v.Item.Id or v.Item.ItemId,Metadata=v.Metadata or v.Item.Metadata,Quantity=v.Quantity or 1}
            elseif typeof(v)=="number" then
                it={Id=tonumber(k) or k,Quantity=v}
            end
            if typeof(it)=="table" and it.Id~=nil then
                local ok,info=pcall(function() return ItemUtil.GetItemDataFromItemType("Items",it.Id) end)
                info = ok and info or nil
                if info and info.Data and info.Data.Type=="Fishes" then
                    local m=it.Metadata or {}
                    local r=m.RarityName
                    if not r then
                        for _,vv in ipairs({m.Rarity,m.RarityId,m.Tier,m.RarityIndex,m.RarityLevel}) do
                            local nm=HUD_TierNumToName(vv); if nm then r=nm break end
                            if typeof(vv)=="string" and #vv>0 then r=vv break end
                        end
                    end
                    if r and string.find(string.upper(r),"SECRET") then return true end
                end
            end
        end
        return false
    end
    local function HUD_Theme(secret)
        local seq=secret and ColorSequence.new{
            ColorSequenceKeypoint.new(0,Color3.fromRGB(90,230,120)),
            ColorSequenceKeypoint.new(0.5,Color3.fromRGB(25,170,70)),
            ColorSequenceKeypoint.new(1,Color3.fromRGB(90,230,120)),
        } or ColorSequence.new{
            ColorSequenceKeypoint.new(0,Color3.fromRGB(60,160,255)),
            ColorSequenceKeypoint.new(0.5,Color3.fromRGB(100,220,255)),
            ColorSequenceKeypoint.new(1,Color3.fromRGB(60,160,255)),
        }
        local g = NeonGrad; g.Color = seq
    end

    local function HUD_Update()
        Title.Text = "Account: "..HUD_DisplayName()
        HUD_TweenCoins(HUD_Coins())
        RodLb.Text   = "Rod: "..HUD_RodText()
        BaitLb.Text  = "Bait: "..HUD_EquippedBaitText()
        CaughtLb.Text= "Caught: "..HUD_CaughtText()
        RarestLb.Text= "Rarest: "..HUD_RarestText()
        HUD_Theme(HUD_HasSecret())
    end

    pcall(function()
        Data:OnChange("Coins", HUD_MarkDirty)
        Data:OnChange("EquippedItems", HUD_MarkDirty)
        Data:OnChange("EquippedType", HUD_MarkDirty)
        Data:OnChange("EquippedId", HUD_MarkDirty)
        Data:OnChange({"Inventory","Fishing Rods"}, HUD_MarkDirty)
        Data:OnChange({"Inventory","Items"}, HUD_MarkDirty)
        for _, key in ipairs(HUD_POSSIBLE_KEYS) do
            Data:OnChange(key, HUD_MarkDirty)
        end
        if Data.OnArrayInsert then
            Data:OnArrayInsert({"Inventory","Baits"}, HUD_MarkDirty)
            Data:OnArrayRemove({"Inventory","Baits"}, HUD_MarkDirty)
        else
            Data:OnChange({"Inventory","Baits"}, HUD_MarkDirty)
        end
    end)

    local function HUD_HookLeaderstats()
        local ls = LP:FindFirstChild("leaderstats")
        if not ls then return end
        local function bind(o) o.Changed:Connect(HUD_MarkDirty) end
        for _,st in ipairs(ls:GetChildren()) do bind(st) end
        ls.ChildAdded:Connect(function(st) bind(st); HUD_MarkDirty() end)
        ls.ChildRemoved:Connect(function() HUD_MarkDirty() end)
    end
    HUD_HookLeaderstats()
    LP.ChildAdded:Connect(function(ch)
        if ch.Name=="leaderstats" then task.wait(0.2); HUD_HookLeaderstats(); HUD_MarkDirty() end
    end)

    task.spawn(function()
        while task.wait(0.2) do
            if HUD_SG.Parent ~= CoreGui and HUD_SG.Parent ~= (gethui and gethui()) then
                HUD_SG.Parent = _safe_gui_parent()
            end
            if HUD_DIRTY then
                HUD_DIRTY = false
                pcall(HUD_Update)
            end
            HUD_SG.Enabled = true
        end
    end)

    HUD_MarkDirty()
end
